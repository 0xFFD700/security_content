name: DLL stealthy execution and file access
id: 525add5c-ab53-11eb-83ee-a683e7ac217d
version: 1
date: '2021-05-02'
author: 'Stanislav Miskovic, Joseph Zadeh, Splunk'
type: streaming
datamodel: []
description:
search: ' | from read_ssa_enriched_events()
          | eval timestamp=parse_long(ucast(map_get(input_event, "_time"), "string", null)),
           cmd_line=ucast(map_get(input_event, "process"), "string", null),
           process_name=ucast(map_get(input_event, "process_name"), "string", null),
           process_path=ucast(map_get(input_event, "process_path"), "string", null),
           parent_process_name=ucast(map_get(input_event, "parent_process_name"), "string", null)
           | where cmd_line != null AND process_name != null AND parent_process_name != null
           AND ( match_regex(cmd_line, /(?i)rundll32.exe.+shell32.dll.+\.exe/)=true
           OR match_regex(cmd_line, /(?i)rundll32.exe.+shell32.dll.+\.dll/)=true
           OR match_regex(cmd_line, /(?i)rundll32.exe.+javascript/)=true
           OR match_regex(cmd_line, /(?i)rundll32.exe.+vbscript/)=true )
           | eval start_time = timestamp, end_time = timestamp, entities = mvappend( ucast(map_get(input_event,
           "dest_user_id"), "string", null), ucast(map_get(input_event, "dest_device_id"), "string", null)), body=create_map(["cmd_line", cmd_line, "process_name", process_name, "parent_process_name", parent_process_name])
           | into write_ssa_detected_events();'
how_to_implement:
- https://github:com/LOLBAS-Project/LOLBAS/tree/master/yml/OSBinaries
tags:
  analytic_story:
  - Unusual Processes
  phases:
  - Actions on Objectives
  - Exploitation
  mitre_attack_id:
  - T1078
  product:
  - UEBA for Security Cloud
  required_fields:
  - _time
  - process_name
  - process_path
  - parent_process
  - dest_device_id
  - dest_user_id
  risk_severity: low
  security_domain: endpoint
