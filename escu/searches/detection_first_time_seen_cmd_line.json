{
  "asset_type": "Endpoint",
  "channel": "ESCU",
  "confidence": "medium",
  "correlation_rule": {
    "notable": {
      "nes_fields": "dest, user, process, cmdline",
      "rule_description": "The system $dest$ executed a command-line argument, $cmdline$, that has not previously been seen.",
      "rule_title": "First-time seen command-line argument was detected on $dest$."
    },
    "risk": {
      "risk_object": "dest",
      "risk_object_type": [
        "system"
      ],
      "risk_score": 50
    },
    "suppress": {
      "suppress_fields": "dest, process, cmdline",
      "suppress_period": "86400s"
    }
  },
  "creation_date": "2018-04-09",
  "data_metadata": {
    "data_source": [
      "Endpoint Intel"
    ],
    "data_sourcetypes": [
      "XmlWinEventLog:Microsoft-Windows-Sysmon/Operational"
    ],
    "providing_technologies": [
      "Carbon Black Response",
      "CrowdStrike Falcon",
      "Sysmon",
      "Tanium",
      "Ziften"
    ]
  },
  "eli5": "The subsearch returns all events where <code>cmd.exe</code> was used with a <code>/c</code> parameter in the command-line arguments to execute other commands/programs. It appends the historical data to those results in the lookup file. Next, it recalculates the <code>firstTime</code> and <code>lastTime</code> field for command-line execution and outputs this data to the lookup file to update the local cache. It returns only those events that have first been seen in the past four hours. This is combined with the main search to return the time, user, destination, process, parent process, and value of the command-line argument.",
  "how_to_implement": "You need to be ingesting logs with both the process name and command line from your endpoints. If you are using Sysmon, you must have at least version 6.0.4 of the Sysmon Technology Add-on (TA). Please make sure you run the support search \"Previously seen command line arguments,\"&#151;which creates a lookup file called <code>previously_seen_cmd_line_arguments.csv</code>&#151;a historical baseline of all command-line arguments. You must also validate this list.",
  "known_false_positives": "Legitimate programs can also use command-line arguments to execute. Please verify the command-line arguments to check what command/program is being executed.",
  "maintainers": [
    {
      "company": "Splunk",
      "email": "bpatel@splunk.com",
      "name": "Bhavin Patel"
    }
  ],
  "mappings": {
    "cis20": [
      "CIS 3",
      "CIS 8"
    ],
    "kill_chain_phases": [
      "Command and Control",
      "Actions on Objectives"
    ],
    "mitre_attack": [
      "Execution",
      "Scripting",
      "Persistence",
      "Command-Line Interface"
    ],
    "nist": [
      "PR.PT",
      "DE.CM",
      "PR.IP"
    ]
  },
  "modification_date": "2018-04-16",
  "original_authors": [
    {
      "company": "Splunk",
      "email": "bpatel@splunk.com",
      "name": "Bhavin Patel"
    }
  ],
  "scheduling": {
    "cron_schedule": "30 * * * *",
    "earliest_time": "-70m@m",
    "latest_time": "-10m@m"
  },
  "search": "sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational process=cmd.exe cmdline=\"* /c *\"  [ search sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational process=cmd.exe cmdline=\"* /c *\" | stats earliest(_time) as firstTime latest(_time) as lastTime by cmdline | inputlookup append=t previously_seen_cmd_line_arguments  | stats min(firstTime) as firstTime, max(lastTime) as lastTime by cmdline | outputlookup previously_seen_cmd_line_arguments | eval newCmdLineArgument=if(firstTime >= relative_time(now(), \"-70m@m\"), 1, 0) | where newCmdLineArgument=1 | `ctime(firstTime)`  | `ctime(lastTime)` | table cmdline] | table _time, user,dest, process, parent_process, cmdline",
  "search_description": "This search looks for command-line arguments that use a <code>/c</code> parameter to execute a command that has not previously been seen.",
  "search_id": "9be56c82-b1cc-4318-87eb-q138afaaqa39",
  "search_name": "First time seen command line argument",
  "search_type": "detection",
  "security_domain": "endpoint",
  "spec_version": 1,
  "version": "2.0"
}
